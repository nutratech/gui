---
name: Release Build

on:
  push:
    tags:
      - "v*"

jobs:
  build-linux-20-04:
    name: "Linux (Ubuntu 20.04)"
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake build-essential \
            qtbase5-dev libqt5sql5-sqlite libgl1-mesa-dev

      - name: Build
        run: make release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nutra-linux-20.04
          path: build/nutra

  build-linux-22-04:
    name: "Linux (Ubuntu 22.04)"
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake build-essential \
            qt6-base-dev libqt6sql6 libqt6sql6-sqlite libgl1-mesa-dev

      - name: Build
        run: make release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nutra-linux-22.04
          path: build/nutra

  build-linux-24-04:
    name: "Linux (Ubuntu 24.04)"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake build-essential \
            qt6-base-dev libqt6sql6 libqt6sql6-sqlite libgl1-mesa-dev

      - name: Build
        run: make release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nutra-linux-24.04
          path: build/nutra

  build-windows:
    name: "Windows"
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.5.0"
          host: "windows"

      - name: Build
        run: make release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nutra-win64.exe
          path: build/Release/nutra.exe

  build-macos:
    name: "macOS"
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.5.0"
          host: "mac"

      - name: Build
        run: make release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nutra-macos.app
          path: build/nutra.app

  release:
    name: "Create Release"
    needs:
      [
        build-linux-20-04,
        build-linux-22-04,
        build-linux-24-04,
        build-windows,
        build-macos,
      ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on master
        run: |
          git fetch origin master
          if ! git merge-base --is-ancestor ${{ github.ref_name }} origin/master; then
            echo "Error: Tag ${{ github.ref_name }} is not on master branch."
            exit 1
          fi

      - name: Check for Pre-release
        id: check_prerelease
        run: |
          if [[ "${{ github.ref_name }}" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Detected pre-release tag."
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Detected stable release tag."
          fi

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          prerelease: ${{ steps.check_prerelease.outputs.is_prerelease }}
          files: |
            artifacts/nutra-linux-20.04/nutra
            artifacts/nutra-linux-22.04/nutra
            artifacts/nutra-linux-24.04/nutra
            artifacts/nutra-win64.exe/nutra.exe
            artifacts/nutra-macos.app/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
